name: CD BACKEND NEOS

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH keys
        run: |
          mkdir -p ~/.ssh
          # Criar uma nova chave privada para SSH
          ssh-keygen -t rsa -b 2048 -f ~/.ssh/blume_key.pem -N ""
          
          # Definir permissões para as chaves
          chmod 600 ~/.ssh/blume_key.pem
          chmod 644 ~/.ssh/blume_key.pem.pub
          chmod 700 ~/.ssh

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Add hostname to /etc/hosts
        run: |
          # Adicionar o hostname para garantir que seja resolvido corretamente
          echo "127.0.0.1 workstation" | sudo tee -a /etc/hosts
          
          # Verificar se a adição foi bem-sucedida
          cat /etc/hosts

      - name: Verify and add the public machine's SSH key
        env:
          PUBLIC_IP: ${{ secrets.CLEAN_PUBLIC_IP }}
        run: |
          # Criar diretório .ssh caso não exista
          mkdir -p ~/.ssh

          # Garantir que o arquivo known_hosts exista
          touch ~/.ssh/known_hosts

          # Adicionar a chave do host da máquina pública (jump server) ao known_hosts
          ssh-keyscan -H $PUBLIC_IP >> ~/.ssh/known_hosts
          
          # Verificar se a chave foi adicionada corretamente
          cat ~/.ssh/known_hosts

      - name: Copy SSH key PEM PUB to the jump server
        env:
          PUBLIC_IP: ${{ secrets.CLEAN_PUBLIC_IP }}
        run: |
          # Copiar a chave pública para o jump server
          sudo ssh-copy-id -i ~/.ssh/blume_key.pem.pub ubuntu@$PUBLIC_IP

          # Verificar se a chave pública foi copiada corretamente
          echo "Chave pública copiada para o jump server com sucesso."

      - name: Deploy Docker image to backend servers
        env:
          PUBLIC_IP: ${{ secrets.PUBLIC_IP }}
          BACKEND_IP_1: ${{ secrets.PRIVATE_IP_1 }}
          BACKEND_IP_2: ${{ secrets.PRIVATE_IP_2 }}
        run: |
          # Conectar ao jump server (pública)
          ssh -i ~/.ssh/blume_key.pem ubuntu@$PUBLIC_IP << 'EOF'
            # Adicionar as chaves das máquinas privadas ao known_hosts
            ssh-keyscan -H ubuntu@$BACKEND_IP_1 >> ~/.ssh/known_hosts
            ssh-keyscan -H ubuntu@$BACKEND_IP_2 >> ~/.ssh/known_hosts

            # Conectar à máquina privada 1
            ssh -i ~/.ssh/blume_key.pem ubuntu@$BACKEND_IP_1 << 'PRIVATE_EOF'
              # Comandos a serem executados no backend 1
              sudo docker ps -a --filter ancestor=victorlcdpaula/backend-neos:latest -q | xargs -r sudo docker stop
              sudo docker ps -a --filter ancestor=victorlcdpaula/backend-neos:latest -q | xargs -r sudo docker rm
              sudo docker pull victorlcdpaula/backend-neos:latest
              sudo docker run -d -p 8080:8080 victorlcdpaula/backend-neos:latest
            PRIVATE_EOF

            # Conectar à máquina privada 2
            ssh -i ~/.ssh/blume_key.pem ubuntu@$BACKEND_IP_2 << 'PRIVATE_EOF'
              # Comandos a serem executados no backend 2
              sudo docker ps -a --filter ancestor=victorlcdpaula/backend-neos:latest -q | xargs -r sudo docker stop
              sudo docker ps -a --filter ancestor=victorlcdpaula/backend-neos:latest -q | xargs -r sudo docker rm
              sudo docker pull victorlcdpaula/backend-neos:latest
              sudo docker run -d -p 8080:8080 victorlcdpaula/backend-neos:latest
            PRIVATE_EOF
          EOF

      - name: Clean up private key
        run: |
          rm -f ~/.ssh/blume_key.pem
